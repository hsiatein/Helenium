import { VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";
import { CircleId } from "utils.slint";

export struct TaskItem {
    id: string,
    task_description: string,
    status: string,
    logs: [string],
    expanded: bool,
}

component StatusCapsule inherits VerticalLayout {
    in property <string> status: "Pending";
    Rectangle {
        private property <brush> capsule-color: status == "Success" ? #b8f2c2
            : status == "Fail" ? #ffc7c7
            : status == "Running" ? #c5ddff
            : status == "Canceled" ? #ffe7a8
            : #d7dde3;

        private property <string> status_str: status == "Success" ? "成功"
            : status == "Fail" ? "失败"
            : status == "Running"? "运行中"
            : status == "Canceled"? "已取消"
            : "等待中";

        background: capsule-color;
        border-radius: 14px;
        height: 32px;
        width: 64px;
        vertical-stretch: 0;
        animate background { duration: 120ms; }

        HorizontalLayout {
            alignment: LayoutAlignment.center;
            Text {
                text: status_str;
                font-size: 13px;
                color: #1c1c1c;
                vertical-alignment: center;
            }
        }
    }
    
}


component CancelButton inherits Rectangle {
    callback clicked();

    width: 15%;
    height: 36px;
    border-radius: 18px;
    background: #ffe1e1;
    border-width: 1px;
    border-color: #ff9b9b;
    animate background { duration: 120ms; }

    touch := TouchArea {
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        alignment: LayoutAlignment.center;
        Text {
            text: "取消任务";
            font-size: 13px;
            color: #c62828;
            vertical-alignment: center;
        }
    }

    states [
        pressed when touch.pressed: {
            opacity: 0.85;
        }
        hover when touch.has-hover: {
            background: #ffd1d1;
        }
    ]
}

component LogsPanel inherits Rectangle {
    in property <[string]> logs: [];

    background: #f6f9ff;
    border-radius: 20px;
    border-width: 1px;
    border-color: #dbe6ff;

    VerticalBox {
        padding: 12px;
        spacing: 8px;
        width: 100%;

        Text {
            text: "任务日志";
            font-size: 14px;
            color: #1c1c1c;
        }

        if (logs.length == 0): Text {
            text: "暂无日志";
            font-size: 13px;
            color: #6b6b6b;
        }

        for log_text[idx] in logs: HorizontalBox {
            spacing: 4px;
            VerticalBox {
                alignment: start;
                Rectangle {
                    width: 6px;
                    height: 6px;
                    border-radius: 3px;
                    vertical-stretch: 0;
                    background: #7fb5ff;
                }
            }
            Text {
                text: log_text;
                font-size: 13px;
                color: #1c1c1c;
                wrap: word-wrap;
            }
        }
    }
}

export component TasksView inherits Rectangle {
    in property <[TaskItem]> tasks: [];
    callback cancel(string);
    callback toggle_logs(string,bool);

    background: #f0f8ff;

    VerticalBox {
        padding: 18px;
        spacing: 12px;
        width: 100%;
        height: 100%;

        Text {
            text: "任务中心";
            font-size: 24px;
            horizontal-alignment: center;
            color: #1c1c1c;
        }

        ScrollView {
            viewport-width: self.width;
            viewport-height: content.preferred-height;
            content := VerticalBox {
                spacing: 14px;
                width: 100%;

                if (root.tasks.length == 0): Rectangle {
                    height: 120px;
                    border-radius: 24px;
                    background: #ffffff;
                    border-width: 1px;
                    border-color: #dbe6ff;
                    Text {
                        text: "暂无任务";
                        font-size: 16px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        color: #6b6b6b;
                    }
                }

                for task in root.tasks : Rectangle {
                    background: #ffffff;
                    border-radius: 28px;
                    border-width: 1px;
                    border-color: #dbe6ff;
                    clip: true;
                    drop-shadow-color: #d3e5ff;
                    drop-shadow-offset-x: 0px;
                    drop-shadow-offset-y: 2px;
                    drop-shadow-blur: 8px;

                    VerticalBox {
                        width: 100%;

                        TouchArea {
                            width: parent.width;
                            height: header.preferred-height;
                            clicked => { task.expanded=!task.expanded;
                                root.toggle_logs(task.id,task.expanded); }

                            header := VerticalBox {
                                width: 100%;

                                HorizontalLayout {
                                    width: parent.width;
                                    
                                    CircleId { }
                                    VerticalLayout {
                                        width: 2%;
                                    }
                                    VerticalLayout {
                                        width: 70%;
                                        Text {
                                            text: task.id;
                                            font-size: 16px;
                                            color: #3f4c67;
                                            wrap: word-wrap;
                                            overflow: elide;
                                            vertical-alignment: center;
                                        }
                                    }
                                    
                                    HorizontalLayout {
                                        width: 20%;
                                        alignment: end;
                                        StatusCapsule { status: task.status; }
                                    }
                                }

                                Text {
                                    text: task.task_description;
                                    font-size: 16px;
                                    color: #1c1c1c;
                                    wrap: word-wrap;
                                    overflow: elide;
                                }

                            }
                        }

                        HorizontalLayout {
                            alignment: LayoutAlignment.start;
                            TouchArea {
                                width: 85%;
                                clicked => { task.expanded=!task.expanded;
                                    root.toggle_logs(task.id,task.expanded); }
                            }
                            if(task.status=="Pending"||task.status=="Running"):
                            CancelButton { clicked => { root.cancel(task.id); } }
                        }

                        if (task.expanded): LogsPanel { logs: task.logs; }
                    }
                }
            }
        }
    }
}